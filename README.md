# MyClude (Cloudflare + React, Free Stack)

Cloudflare Worker + D1 + R2(private), and React + Vite frontend deployed to GitHub Pages.

## Architecture

- Backend: `apps/worker` (TypeScript)
- Frontend: `apps/web` (React + Vite + TypeScript)
- Auth: JWT in HttpOnly cookie
- Storage: private R2 with presigned PUT/GET generated by Worker (`aws4fetch`)
- DB: D1 (`users`, `albums`, `album_items`, `album_progress`)
- Security:
  - CORS only allows configured frontend origin
  - HttpOnly cookie (`Secure`, `SameSite=None`)
  - album owner validation on album/image/progress APIs

## R2 key rules

- `albums/{albumId}/thumb/{imageId}.webp`
- `albums/{albumId}/preview/{imageId}.webp`

## Prerequisites

- Node.js 20+
- Cloudflare account
- Wrangler CLI (`npm i -g wrangler` optional, or use workspace script)

## Install

```bash
npm install
```

## Configure Cloudflare resources

1. Create D1 DB:
```bash
cd apps/worker
npx wrangler d1 create myclude-db
```
2. Put returned `database_id` into `apps/worker/wrangler.toml`.
3. Apply migration:
```bash
npx wrangler d1 migrations apply myclude-db --local
npx wrangler d1 migrations apply myclude-db --remote
```
4. Create private R2 bucket (example: `myclude-private`).
5. Create R2 API token/key pair for S3 API.
6. Edit `apps/worker/wrangler.toml` vars:
   - `FRONTEND_ORIGIN`
   - `GOOGLE_CLIENT_ID`
   - `GOOGLE_REDIRECT_URI`
   - `R2_S3_ENDPOINT` (`https://<accountid>.r2.cloudflarestorage.com`)
   - `R2_BUCKET`
   - `JWT_COOKIE_NAME`, `JWT_EXPIRES_SECONDS`
7. Set Worker secrets (recommended, do not store in git):
```bash
cd apps/worker
echo "<R2_ACCESS_KEY_ID>" | npx wrangler secret put R2_ACCESS_KEY_ID
echo "<R2_SECRET_ACCESS_KEY>" | npx wrangler secret put R2_SECRET_ACCESS_KEY
echo "<JWT_SECRET>" | npx wrangler secret put JWT_SECRET
echo "<GOOGLE_CLIENT_SECRET>" | npx wrangler secret put GOOGLE_CLIENT_SECRET
```

## Google Login setup

1. In Google Cloud Console, create OAuth Client ID (Web application).
2. Authorized redirect URIs:
   - Local: `http://127.0.0.1:8787/api/auth/google/callback`
   - Prod: `https://myclude-worker.xkqvor123.workers.dev/api/auth/google/callback`
3. Put `GOOGLE_CLIENT_ID` and `GOOGLE_REDIRECT_URI` in `wrangler.toml`.
4. Put `GOOGLE_CLIENT_SECRET` as Worker secret (`wrangler secret put`).
5. Run D1 migration `0002_google_oauth.sql` before using Google login.

## Local development

1. Run worker:
```bash
npm run dev:worker
```
2. Create `apps/web/.env.local`:
```bash
VITE_API_BASE=http://127.0.0.1:8787
VITE_BASE_PATH=/
```
3. Run web:
```bash
npm run dev:web
```
4. Open `http://localhost:5173`.

## Deploy Worker

```bash
cd apps/worker
npx wrangler deploy
```

Save worker URL, e.g. `https://myclude-worker.<subdomain>.workers.dev`.

## Deploy frontend to GitHub Pages

1. Push this repo to GitHub and set default branch to `main`.
2. In GitHub repo settings:
   - `Settings > Pages > Source`: `GitHub Actions`
3. In GitHub repo `Settings > Secrets and variables > Actions > Variables`, add:
   - `VITE_API_BASE=https://myclude-worker.<subdomain>.workers.dev`
   - `VITE_BASE_PATH=/REPO_NAME/`
4. Push to `main` (or run workflow manually):
   - `.github/workflows/deploy-pages.yml`
5. After deploy, set Worker `FRONTEND_ORIGIN` to your GitHub Pages origin:
   - example: `https://<username>.github.io`

## API summary

- `POST /api/auth/register`
- `POST /api/auth/login`
- `GET /api/auth/google/start`
- `GET /api/auth/google/callback`
- `POST /api/auth/logout`
- `GET /api/auth/me`
- `GET /api/albums`
- `POST /api/albums`
- `PATCH /api/albums/:albumId`
- `DELETE /api/albums/:albumId`
- `POST /api/albums/:albumId/images/presign-put`
- `GET /api/albums/:albumId/images/:imageId/presign-get`
- `GET /api/albums/:albumId/items`
- `DELETE /api/albums/:albumId/items/:imageId`
- `GET /api/albums/:albumId/progress`
- `POST /api/albums/:albumId/progress`

## Notes

- Browser compression converts uploads to `webp` (thumb/preview) before PUT.
- Text files (`txt`, `md`, `json`, `csv`, `log`, `text/*`) are uploaded as-is and previewed in viewer.
- `items` endpoint returns presigned GET URLs for rendering thumbnails and previews.
- All album endpoints verify that the caller owns the album.
